# === –ü–∞—Ä–∞–º–µ—Ç—Ä—ã ===

RS_PACKAGE_NAME="com.alternadv.vedhelper"

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–Ω–æ–≤–∏–∫–∞
APP_NAME="–ü–æ–º–æ—â–Ω–∏–∫ –í–≠–î"
APP_TYPE="MAIN"
CATEGORIES="[\"business\",\"tools\"]"
AGE_LEGAL="0+"
SHORT_DESCRIPTION="–ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤–Ω–µ—à–Ω–µ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
FULL_DESCRIPTION="–ü–æ–º–æ—â–Ω–∏–∫ –í–≠–î ‚Äî —ç—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤–Ω–µ—à–Ω–µ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏,
  –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–º–æ–≥–∞–µ—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞–º–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ç–∞–≤–∫–∞—Ö, –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö –∏
  –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö. –°–µ—Ä–≤–∏—Å —ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è –∏ —É–ø—Ä–æ—â–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –í–≠–î, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è –ø–æ–ª–µ–∑–Ω—ã–µ
  –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤, –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π.

  –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
  - –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –í–≠–î
  - –û–±–Ω–æ–≤–ª—è–µ–º–∞—è –±–∞–∑–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  - –£–¥–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞—Å—á—ë—Ç–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞

  –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ª–æ–≥–∏—Å—Ç–æ–≤, —Ç–∞–º–æ–∂–µ–Ω–Ω—ã—Ö –±—Ä–æ–∫–µ—Ä–æ–≤ –∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –ø–æ –í–≠–î."
WHATS_NEW="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"
MODER_INFO="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞"
PUBLISH_TYPE="MANUAL"
PARTIAL_VALUE="5"
PRIORITY_UPDATE="0"
PRICE_VALUE="0"

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã APK
SERVICES_TYPE="Unknown"
IS_MAIN_APK=true
APK_FILE_PATH="app.apk"
AAB_FILE_PATH="app.aab"

# === –°–ª—É–∂–µ–±–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ===

# –°–ª—É–∂–µ–±–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
COLOR_RED="[91m"
COLOR_GREEN="[92m"
COLOR_RS_BLUE="[0;34m"
COLOR_CYAN="[96m"
COLOR_RESET="[0m"

ERROR_LOG="${COLOR_RED}–û—à–∏–±–∫–∞$COLOR_RESET"
SUCCESS_LOG="${COLOR_GREEN}–£—Å–ø–µ—Ö$COLOR_RESET"
RS_API="${COLOR_RS_BLUE}RuStore API$COLOR_RESET"

RS_API_LOG="[${COLOR_RS_BLUE}RuStore API$COLOR_RESET]"
RS_JWE_SECTION="[${COLOR_CYAN}–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞$COLOR_RESET]"
RS_CVD_SECTION="[${COLOR_CYAN}–°–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –≤–µ—Ä—Å–∏–∏$COLOR_RESET]"
RS_APK_SECTION="[${COLOR_CYAN}–ó–∞–≥—Ä—É–∑–∫–∞ .apk —Ñ–∞–π–ª–∞$COLOR_RESET]"
RS_AAB_SECTION="[${COLOR_CYAN}–ó–∞–≥—Ä—É–∑–∫–∞ .aab —Ñ–∞–π–ª–∞$COLOR_RESET]"
RS_STM_SECTION="[${COLOR_CYAN}–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é$COLOR_RESET]"


# === –§—É–Ω–∫—Ü–∏–∏ ===

# –§—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏—Å–∫–æ–º–æ–≥–æ –ø–æ–ª—è
function retrieve_field_from {
	echo $(echo $2 | sed -E 's/.*"'$1'":"?([^,"]*)"?.*/\1/')
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
function check_if_empty {
	if [ -z "$1" ]
		then
			echo $ERROR_LOG
			echo "–û—Ç–≤–µ—Ç –æ—Ç $RS_API –Ω–µ –ø—Ä–∏—à–µ–ª. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞"
			exit 1
	fi
}

# –ü–æ–∏—Å–∫ –ø–æ–ª—è "message" –≤ –æ—Ç–≤–µ—Ç–µ —Å –∫–æ–¥–æ–º "ERROR"
function find_error_msg {
	if [ "$(retrieve_field_from code "$1")" = "ERROR" ]
		then
			echo "$(retrieve_field_from message "$1")"
	fi
}


# –ü–æ–ª—É—á–µ–Ω–∏–µ JWE-—Ç–æ–∫–µ–Ω–∞
function get_jwe_token {

	echo -n "$RS_API_LOG $RS_JWE_SECTION –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞...  "

	# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–π–º—Å—Ç–∞–º–ø–∞
	timestamp=$(date +'%Y-%m-%dT%H:%M:%S.999999999%z')
	timestamp=${timestamp:0:32}:${timestamp:32:33}

	# –•–µ—à–∏—Ä—É–µ—É–º–∞—è —Å—Ç—Ä–æ–∫–∞
	data=$RS_KEY_ID$timestamp

	# –•–µ—à –∏ –ø–æ–¥–ø–∏—Å—å
	echo "$RS_PRIVATE_KEY" | base64 -d > pkey.p8 | openssl rsa -in pkey.p8 -out rsa.pem > /dev/null 2>&1
	signature=$(echo -ne "$data" | openssl sha512 -sign rsa.pem | base64; rm pkey.p8 rsa.pem)
	signature=$(echo $signature | tr -d '\n' )

	# –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞
	response_json=$(
		curl https://public-api.rustore.ru/public/auth/ \
		--silent \
		--json "{
			\"keyId\":\"${RS_KEY_ID}\",
			\"timestamp\":\"${timestamp}\",
			\"signature\":\"${signature}\"
		}"
	)

	# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
	check_if_empty "${response_json}"

	if [ "$(retrieve_field_from code "${response_json}")" = "OK" ]
		then
			JWE_TOKEN=$(retrieve_field_from jwe "${response_json}")
			echo $SUCCESS_LOG
		else
			echo $ERROR_LOG
			find_error_msg "${response_json}"
			exit 1
	fi

}

# –°–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –≤–µ—Ä—Å–∏–∏
function create_version_draft {

	echo -n "$RS_API_LOG $RS_CVD_SECTION –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞...  "

	# –ó–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞
	create_draft_json=$(
		curl \
		--silent \
		--location \
		--request POST "https://public-api.rustore.ru/public/v1/application/$RS_PACKAGE_NAME/version" \
		--header 'Content-Type: application/json' \
		--header "Public-Token: $JWE_TOKEN" \
		--json "{
			\"appName\":\"$APP_NAME\",
			\"appType\":\"$APP_TYPE\",
			\"categories\": $CATEGORIES,
			\"ageLegal\":\"$AGE_LEGAL\",
			\"shortDescription\":\"$SHORT_DESCRIPTION\",
			\"fullDescription\":\"$FULL_DESCRIPTION\",
			\"whatsNew\":\"$WHATS_NEW\",
			\"moderInfo\":\"$MODER_INFO\",
			\"publishType\":\"$PUBLISH_TYPE\",
			\"partialValue\":\"$PARTIAL_VALUE\"

		}"
	)

	# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
	check_if_empty "${create_draft_json}"

	if [ "$(retrieve_field_from code "${create_draft_json}")" = "OK" ]
		then
			VERSION_ID=$(retrieve_field_from body "${create_draft_json}")
			echo $SUCCESS_LOG
		else
			echo $ERROR_LOG
			find_error_msg "${create_draft_json}"
			exit 1
	fi
}

# –ó–∞–≥—Ä—É–∑–∫–∞ APK
function upload_apk {
	echo -e "$RS_API_LOG $RS_APK_SECTION –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞...  "

	# –ó–∞–ø—Ä–æ—Å –∑–∞–≥—Ä—É–∑–∫–∏
	upload_apk_json=$(
		curl \
		--silent \
		--request POST "https://public-api.rustore.ru/public/v1/application/$RS_PACKAGE_NAME/version/$VERSION_ID/apk?servicesType=$SERVICES_TYPE&isMainApk=$IS_MAIN_APK" \
		--header "Public-Token: $JWE_TOKEN" \
		--form "file=@\"$APK_FILE_PATH\""
	)

	# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
	check_if_empty "${upload_apk_json}"

	if [ "$(retrieve_field_from code "${upload_apk_json}")" = "OK" ]
		then
			echo $SUCCESS_LOG
		else
			echo $ERROR_LOG
			find_error_msg "${upload_apk_json}"
			exit 1
	fi
}

# –ó–∞–≥—Ä—É–∑–∫–∞ AAB
function upload_aab {
	echo -n "$RS_API_LOG $RS_AAB_SECTION –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞...  "

	# –ó–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞
	upload_aab_json=$(
		curl \
		--silent \
		--location \
		--request POST "https://public-api.rustore.ru/public/v1/application/$RS_PACKAGE_NAME/version/$VERSION_ID/aab" \
		--header "Public-Token: $JWE_TOKEN" \
		--form "file=@\"$AAB_FILE_PATH\""
	)

	# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
	check_if_empty "${upload_aab_json}"

	if [ "$(retrieve_field_from code "${upload_aab_json}")" = "OK" ]
		then
			echo $SUCCESS_LOG
		else
			echo $ERROR_LOG
			find_error_msg "${upload_aab_json}"
			exit 1
	fi
}

# –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é
function send_to_moderation {

	echo -n "$RS_API_LOG $RS_STM_SECTION –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞...  "

	# –ó–∞–ø—Ä–æ—Å
	send_to_moderation_json=$(
		curl \
		--silent \
		--location \
		--request POST "https://public-api.rustore.ru/public/v1/application/$RS_PACKAGE_NAME/version/$VERSION_ID/commit?priorityUpdate=$PRIORITY_UPDATE" \
		--header "Public-Token: $JWE_TOKEN"
	)

	# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
	check_if_empty "${send_to_moderation_json}"

	if [ "$(retrieve_field_from code "${send_to_moderation_json}")" = "OK" ]
		then
			echo $SUCCESS_LOG
		else
			echo $ERROR_LOG
			find_error_msg "${send_to_moderation_json}"
			exit 1
	fi
}

# === –°—Ü–µ–Ω–∞—Ä–∏–π ===
function main {
  get_jwe_token
  create_version_draft
  upload_apk
  # upload_aab
  send_to_moderation
}

main
